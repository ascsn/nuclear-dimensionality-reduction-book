

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Efficient Emulation of SECAR Beam &#8212; Dimensionality Reduction in Nuclear Physics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'blackbox_galerkin/SECAR';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Non-linear and non-affine problem" href="DFT_Toy_Model.html" />
    <link rel="prev" title="Aplication 5: Black-Box Methods" href="Introduction.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../landing.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../landing.html">
                    Introduction to Dimensionality Reduction in Nuclear Physics
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction/introduction.html">Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/emulators.html">Why emulators?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ho/1dHO.html">Application 1: The Quantum Harmonic Oscillator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scattering/scattering.html">Application 2: Two body single channel nuclear scattering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scattering/eim.html">Application 3: The Empirical Interpolation Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HO_Time/HO_Time_Dependent.html">Application 4: Time Dependent Systems (evolution in the reduced space)</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Introduction.html">Aplication 5: Black-Box Methods</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Efficient Emulation of SECAR Beam</a></li>
<li class="toctree-l2"><a class="reference internal" href="DFT_Toy_Model.html">Non-linear and non-affine problem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/ascsn/nuclear-dimensionality-reduction-book/main?urlpath=tree/nuclear-dr/blackbox_galerkin/SECAR.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/ascsn/nuclear-dimensionality-reduction-book/blob/main/nuclear-dr/blackbox_galerkin/SECAR.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ascsn/nuclear-dimensionality-reduction-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ascsn/nuclear-dimensionality-reduction-book/issues/new?title=Issue%20on%20page%20%2Fblackbox_galerkin/SECAR.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/blackbox_galerkin/SECAR.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Efficient Emulation of SECAR Beam</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolation-emulator-for-secar">Interpolation Emulator for SECAR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-helpers-for-reading-cosy-files">Some helpers for reading COSY files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cubicspline-based-emulator">CubicSpline based Emulator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interface-between-cosy-file-reading-and-the-emulators">Interface between COSY file reading and the emulators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#black-box-emulator-for-secar">Black-Box Emulator for SECAR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-now-try-a-new-approach-which-more-closely-resembles-the-galerkin-approach-to-rbm-s">We now try a new approach which more closely resembles the Galerkin approach to RBM’s.</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="efficient-emulation-of-secar-beam">
<h1>Efficient Emulation of SECAR Beam<a class="headerlink" href="#efficient-emulation-of-secar-beam" title="Permalink to this heading">#</a></h1>
<p>Contributed by: Diógenes Figueroa, Ruchi Garg
Edited by: Pablo Giuliani</p>
<p>This section is based on a final project for the <a class="reference external" href="https://indico.frib.msu.edu/event/65/">FRIB-TA Summer School: Practical Uncertainty Quantification and Emulator Development in Nuclear Physics</a>, all code shown here are simplified versions of the publicly final project repository available here: <a class="reference external" href="https://github.com/diogenes1991/RBMSecar">RBM SECAR</a></p>
<p>In this section we discuss how to apply the reduced basis method to problems for which the underlying dynamics are unknown or complicated enough that tracking the dependence on the parametrs of interest is unfeasible. We will explore two kinds of emulators:</p>
<ul class="simple">
<li><p><strong>Interpolation Emulators</strong>: For these kinds of emulators the idea is to use the information obtained from the high-fidelity solver to build interpolators for the coefficients of the principal components.</p></li>
<li><p><strong>BlackBox Emulators</strong>: For these kind of emulators we try to find some effective dynamics for our problem and build the equivalent of the Galerkin projection equations for those.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">array</span><span class="o">,</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">CubicSpline</span>
</pre></div>
</div>
</div>
</div>
<section id="interpolation-emulator-for-secar">
<h2>Interpolation Emulator for SECAR<a class="headerlink" href="#interpolation-emulator-for-secar" title="Permalink to this heading">#</a></h2>
<p>The problem that we are trying to tackle here is the emulation of beam dynamics for the <a class="reference external" href="http://secar.space/">SECAR</a> recoil separator, as discussed at the introduction of this book. These dynamics are governed by the interactions between the charged particles in the beams and the magnetic fields generated by each one of the 19 electromagnets of the experiment. Each one of these magnets influences the trajectory of the beams, an effect which we can parametrize as a power series on the characteristics of the beam is employed. For simplicity we shall parametrize the state of the electromagnets as one-dimensional, depending only on the current <span class="math notranslate nohighlight">\(I\)</span> flowing through it. Symbolically, if we denote by <span class="math notranslate nohighlight">\(v\)</span> the state of the beam, the transport equation looks like:</p>
<div class="amsmath math notranslate nohighlight" id="equation-77c2a338-1028-4a50-92d5-55e61000e8a7">
<span class="eqno">(44)<a class="headerlink" href="#equation-77c2a338-1028-4a50-92d5-55e61000e8a7" title="Permalink to this equation">#</a></span>\[\begin{equation}
    v^{after}_i = (S^0[I])_i + (S^1[I])_i{}^jv^{before}_j + (S^2[I])_i{}^{jk}v^{before}_jv^{before}_k+\cdots 
\end{equation}\]</div>
<p>In the case of SECAR, the tensors <span class="math notranslate nohighlight">\(S^0,S^1,\cdots\)</span> (i.e. the high-fidelity solutions) are calculated by the <a class="reference external" href="https://www.bmtdynamics.org/index_cosy.htm">COSY INFINITY</a> system. This program is capable of finding these transport tensors for any order. In the application we show here the COSY program has been used to generate <span class="math notranslate nohighlight">\(100\)</span> high-fidelity solutions for the transport of beams described by <span class="math notranslate nohighlight">\(8\)</span> state variables. Tensors of degree up to <span class="math notranslate nohighlight">\(4\)</span> are kept.</p>
<p>Our reduced basis approximation will read:</p>
<div class="amsmath math notranslate nohighlight" id="equation-9a8d8529-8bb3-45f3-bc5d-5558fba77d0a">
<span class="eqno">(45)<a class="headerlink" href="#equation-9a8d8529-8bb3-45f3-bc5d-5558fba77d0a" title="Permalink to this equation">#</a></span>\[\begin{equation}
    S^{l} (I) \approx \hat S^{l} (I) = \sum_{k=1}^n a_k^l(I) S_k^{l},
\end{equation}\]</div>
<p>for every tensor <span class="math notranslate nohighlight">\(S^{l}\)</span> <span class="math notranslate nohighlight">\((l=0,1,\cdots)\)</span>. Now, the dependence on the current is carried by the coefficients <span class="math notranslate nohighlight">\(a_k^l(I)\)</span></p>
<section id="some-helpers-for-reading-cosy-files">
<h3>Some helpers for reading COSY files<a class="headerlink" href="#some-helpers-for-reading-cosy-files" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span>

<span class="k">def</span> <span class="nf">generate_lookup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="n">low_pow</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lowPower&quot;</span><span class="p">]</span>
    <span class="n">hig_pow</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;highPower&quot;</span><span class="p">]</span>
    <span class="n">num_let</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nLetters&quot;</span><span class="p">]</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Generate all nLetters words &#39;&#39;&#39;</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_let</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">low_pow</span><span class="p">,</span> <span class="n">hig_pow</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">combinations_list</span> <span class="o">=</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">letters</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">words</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span> <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">combinations_list</span><span class="p">])</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Convert from words to a lookup table &#39;&#39;&#39;</span>
    <span class="n">word_to_list</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">word</span>       <span class="p">:</span> <span class="p">[</span>  <span class="nb">str</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">letter</span><span class="p">))</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">letters</span> <span class="p">]</span>
    <span class="n">list_to_key</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">base</span><span class="p">,</span><span class="n">array</span> <span class="p">:</span> <span class="n">list_to_key</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="k">else</span> <span class="n">base</span>
    <span class="n">word_to_key</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">word</span>       <span class="p">:</span> <span class="n">list_to_key</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">word_to_list</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Lookup table &#39;&#39;&#39;</span>
    <span class="n">lookup</span>   <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">[</span> <span class="p">(</span><span class="n">word_to_key</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))</span> <span class="p">]</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lookup</span>

<span class="k">class</span> <span class="nc">CosyIO</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;  </span>
<span class="sd">        COSY Formatted files reader class</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nLetters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">lowPower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">highPower</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nLetters</span>  <span class="o">=</span> <span class="n">nLetters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowPower</span>  <span class="o">=</span> <span class="n">lowPower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">higiPower</span> <span class="o">=</span> <span class="n">highPower</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; We generate a static lookup table to synchronize all matrices &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">generate_lookup</span><span class="p">(</span><span class="n">lowPower</span><span class="o">=</span><span class="n">lowPower</span><span class="p">,</span><span class="n">highPower</span><span class="o">=</span><span class="n">highPower</span><span class="p">,</span><span class="n">nLetters</span><span class="o">=</span><span class="n">nLetters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">]</span> <span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Convert keys to list of powers &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_to_list</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_to_list</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">l</span><span class="o">+</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">l</span>
        
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Save specifications &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="k">continue</span>
<span class="w">                </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Skip Matrix header &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;I&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">continue</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Append at the end of matrix character &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">footer</span> <span class="o">=</span> <span class="n">line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_mat</span><span class="p">)</span>
                <span class="n">local_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            
            <span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; Build the key to lookup &#39;&#39;&#39;</span>
                <span class="n">word</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)):</span>
                    <span class="n">word</span><span class="o">+=</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">local_mat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="n">word</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cubicspline-based-emulator">
<h3><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.CubicSpline.html#scipy.interpolate.CubicSpline">CubicSpline</a> based Emulator<a class="headerlink" href="#cubicspline-based-emulator" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Emulator</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        Interpolation-Based Emulator </span>
<span class="sd">        Uses Cubic Splines to interpolate the </span>
<span class="sd">        principal components&#39; coefficients </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">matrix</span><span class="p">,</span><span class="n">cutoff</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis</span>   <span class="o">=</span> <span class="n">axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Normalize the data &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdevs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renor</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span>
                                <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> 
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdevs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> 
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="p">]</span> 
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renor</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Build all the CubicSpline interpolators &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Find the Principal Components &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renor</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Build all the CubicSpline interpolators for the coefficients &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splines</span> <span class="o">=</span> <span class="p">[</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">CubicSpline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">):</span>
            <span class="n">rval</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splines</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sdevs</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">means</span>
        <span class="k">return</span> <span class="n">rval</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interface-between-cosy-file-reading-and-the-emulators">
<h3>Interface between COSY file reading and the emulators<a class="headerlink" href="#interface-between-cosy-file-reading-and-the-emulators" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CosyMagnet</span><span class="p">(</span><span class="n">Emulator</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Wrapped emulator for the Cosy format &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Load all the datafile names and assume the scale is the name  &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">scales</span>      <span class="o">=</span> <span class="p">[</span> <span class="nb">float</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="p">]</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Format the flattened data matrix, file = row &#39;&#39;&#39;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cosyIO</span> <span class="o">=</span> <span class="n">CosyIO</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">                Here we should save the magnet specs and complain if </span>
<span class="sd">                some magnets do not have the same specs</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cosyIO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Flatten the matrices &#39;&#39;&#39;</span>
            <span class="n">big_row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosyIO</span><span class="o">.</span><span class="n">matrices</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
                    <span class="n">big_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">big_row</span><span class="p">)</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Emulator build &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;cutoff&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span><span class="n">matrix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Now we can start importing high-fidelity solutions and trian some emulators</strong></p>
<p>First we train <span class="math notranslate nohighlight">\(n=7\)</span> emulators using the test data with a different number of reduced basis. We focus on the first SECAR magnet Q1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_to_magnet</span> <span class="o">=</span> <span class="s2">&quot;MagnetData/Q1/train&quot;</span>
<span class="n">nEmulators</span>     <span class="o">=</span> <span class="mi">7</span>
<span class="n">Emulators</span>      <span class="o">=</span> <span class="p">[</span> <span class="n">CosyMagnet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path_to_magnet</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nEmulators</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s see the actual data and see how the singular components decay. These components will be our reduced basis <span class="math notranslate nohighlight">\(S^l_k\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">Emulators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">s</span><span class="p">[:</span><span class="mi">25</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Singular Value #&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Singular Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3ac45b425c4b941b2bbdc52f2c4183a98578b0bc3641f0a36a1a6674f767aec0.png" src="../_images/3ac45b425c4b941b2bbdc52f2c4183a98578b0bc3641f0a36a1a6674f767aec0.png" />
</div>
</div>
<p>This tells us that by keeping 5-10 singular values we would capture most of the dynamics.
Since we are also interpolating the coefficients <span class="math notranslate nohighlight">\(a_k^l(I)\)</span> it might be a good idea to look at them, since if they are not smooth enough we might get bad results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Emulators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span><span class="n">Emulators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$a_</span><span class="si">{}</span><span class="s2">(I)$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Principal Components Coefficients vs. Current&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Current (A)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3326a62e3bfd8fc2b9d7415cfbc366565c3c4a380237418fe5524a525887d3b7.png" src="../_images/3326a62e3bfd8fc2b9d7415cfbc366565c3c4a380237418fe5524a525887d3b7.png" />
</div>
</div>
<p>We see that most of them are pretty smooth, but the discontinuities on the smaller pcs might prevent us from reaching really small errors.</p>
<p><strong>Accuarcy of the emulatiors</strong></p>
<p>For this we use dummy CosyMagnet instance to load the test dataset into python</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_Magnet</span> <span class="o">=</span> <span class="n">CosyMagnet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;MagnetData/Q1/test&quot;</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">scales</span>   <span class="o">=</span> <span class="n">test_Magnet</span><span class="o">.</span><span class="n">axis</span>
<span class="n">matrices</span> <span class="o">=</span> <span class="n">test_Magnet</span><span class="o">.</span><span class="n">matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">emulated</span><span class="p">,</span><span class="n">real</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">emulated</span> <span class="o">-</span> <span class="n">real</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">real</span><span class="p">)))</span>

<span class="n">error_matrix</span>   <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">error</span><span class="p">(</span><span class="n">Emulators</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">scales</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="n">matrices</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scales</span><span class="p">))</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nEmulators</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nEmulators</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span><span class="n">error_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;# of pc = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Emulators</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cutoff</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Current (A)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sqrt{\sum ||Emulated - Data||^2}$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Error plot&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5d3c947dd4fadffd2d67ee51dc64e44c639e4d0f7205e2537e517c466344eed1.png" src="../_images/5d3c947dd4fadffd2d67ee51dc64e44c639e4d0f7205e2537e517c466344eed1.png" />
</div>
</div>
<p>Here we notice that the error becomes worse near the places of discontinuity of the original coefficients. We could use these emulators to evaluate beam transport, see: <a class="reference external" href="https://github.com/diogenes1991/RBMSecar/blob/master/Emulator/RBM.ipynb">RBM SECAR</a> for more details. One way to improve on this issue would be to build effective dynamical equations for our system, as we show next.</p>
</section>
</section>
<section id="black-box-emulator-for-secar">
<h2>Black-Box Emulator for SECAR<a class="headerlink" href="#black-box-emulator-for-secar" title="Permalink to this heading">#</a></h2>
<section id="we-now-try-a-new-approach-which-more-closely-resembles-the-galerkin-approach-to-rbm-s">
<h3>We now try a new approach which more closely resembles the Galerkin approach to RBM’s.<a class="headerlink" href="#we-now-try-a-new-approach-which-more-closely-resembles-the-galerkin-approach-to-rbm-s" title="Permalink to this heading">#</a></h3>
<p>The main issue is that although we have the PCs there is no defining equation <span class="math notranslate nohighlight">\(F_\alpha[\phi]=0 \)</span> to project, <span class="math notranslate nohighlight">\(\alpha\)</span> now taking the role of the current and <span class="math notranslate nohighlight">\(\phi\)</span> the role of the tensors <span class="math notranslate nohighlight">\(S^l\)</span>. Lacking access to these equations is what motivated us to interpolate the reduced coefficients <span class="math notranslate nohighlight">\(a_k(I)\)</span>.</p>
<p>Inspired by how for some of the previous systems we have studied in this book the dynamical equations reduced to an effective Hamiltonian, we now try to find some such a reduced operator for our problem. In this formulation we interpret the projection of the COSY matrix onto the principal components as a wavefunction and encode our problem into an eigenvalue-eigenvector problem, more precisely:</p>
<p><span class="math notranslate nohighlight">\(\mathcal{H}_{\text{Eff}}(x;I) \Psi(x;I) = E\Psi(x;I) \)</span></p>
<p>The problem being that the COSY matrices are not wavefunctions and thus their magnitude is important, but the eigenvalue problem is defined modulo multiplication by any non-zero factor <span class="math notranslate nohighlight">\(K(I)\)</span>, constant over <span class="math notranslate nohighlight">\(x\)</span>. We can fix this “gauge” in many ways, for example, by adding a known <span class="math notranslate nohighlight">\(G(I)\)</span> function as a new component to be emulated. Upon emulation we look at the value of this channel and since we know the value it should have we know the scale factor needed for the system to be correct.</p>
<p>We employ a power expansion model for the hamiltonians:</p>
<p><span class="math notranslate nohighlight">\(\mathcal{H}_{Eff} = \sum_{s=0}^{\infty} \mathcal{H}_{s} I^s\)</span></p>
<p>for some matrices <span class="math notranslate nohighlight">\(\mathcal{H}_{s}\in M(m\times m)\)</span> where <span class="math notranslate nohighlight">\(m\)</span> is the number of principal components we wish to model. Our objective now is to find the numerical values of these matrices from data.</p>
<p><strong>We sart with some definitions</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>

<span class="k">def</span> <span class="nf">build_pdm</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">parity</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Builds a parity defined matrix &#39;&#39;&#39;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>  <span class="c1"># Initialize matrix with zeros</span>
    <span class="n">cc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span> <span class="k">if</span> <span class="n">parity</span><span class="o">==-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">coefficient</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span>  <span class="c1"># Correct indexing</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefficient</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parity</span><span class="o">*</span><span class="n">coefficient</span>
            <span class="n">cc</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrix</span>

<span class="k">class</span> <span class="nc">Hamiltonian</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        Implements eigenvalue-eigenvector porblem fitter</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis</span>              <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span>              <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="w">     </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Enforce Eigenvectors &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">variables</span><span class="p">):</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">            </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Build H0, H1, ... &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hs</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_method</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numEntries</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numEntries</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ord</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span><span class="p">):</span>
<span class="w">                </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Loop over orders &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ord</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Compute Eigenvectors and add residue as difference &#39;&#39;&#39;</span>
            <span class="n">evl</span><span class="p">,</span><span class="n">evc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
            <span class="n">rval</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span> <span class="n">evc</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">evc</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">vec</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
         
        <span class="k">return</span> <span class="n">rval</span>
         
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dimension</span><span class="p">,</span><span class="n">order</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Here we build an approximate to the Galerkin Equations &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ord</span> <span class="o">=</span> <span class="n">order</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; First we project every datapoint onto the first dim principal components &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="p">])</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Normalize once &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_dim_rep</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Setup a minimization problem &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numEntries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_dimension</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ord</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numEntries</span><span class="p">)]</span> <span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Minimization call &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_solution</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">op_solution</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">predict_pcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha</span><span class="p">):</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ord</span><span class="p">):</span>
            <span class="n">H</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_real</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha</span><span class="p">):</span>
        <span class="bp">NotImplemented</span>
        
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">NotImplemented</span>
    
    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">NotImplemented</span>   

<span class="k">class</span> <span class="nc">RealHamiltonian</span><span class="p">(</span><span class="n">Hamiltonian</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_dimension</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dim</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="o">*</span><span class="p">(</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_method</span>    <span class="o">=</span> <span class="n">build_pdm</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_real</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha</span><span class="p">):</span>
        <span class="n">evl</span><span class="p">,</span><span class="n">evc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_pcs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">rval</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Loop over principal components &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
            <span class="n">rval</span> <span class="o">+=</span> <span class="n">evc</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="n">rval</span>
    
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Loop over eigenfunctions &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Loop over known scales &#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">:</span>
                <span class="n">evl</span><span class="p">,</span><span class="n">evc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_pcs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">rval</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; Loop over principal components &#39;&#39;&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
                    <span class="n">rval</span> <span class="o">+=</span> <span class="n">evc</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
<span class="w">                </span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; Plot normalized wavefunctions &#39;&#39;&#39;</span>
                <span class="n">rval</span> <span class="o">=</span> <span class="n">rval</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Loop over known scales &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">):</span>
            
            <span class="n">evl</span><span class="p">,</span><span class="n">evc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
            <span class="n">rval</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Loop over principal components &#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">):</span>
                <span class="n">rval</span> <span class="o">+=</span> <span class="n">evc</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Plot normalized wavefunctions &#39;&#39;&#39;</span>
            <span class="n">rval</span> <span class="o">=</span> <span class="n">rval</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Sign at the center &#39;&#39;&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">rval</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rval</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>
<span class="w">            </span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Why did we transpose the data again? &#39;&#39;&#39;</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">rval</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="n">i</span><span class="p">]))</span>
        
        <span class="k">return</span> <span class="n">error</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Again we satrt by using a CosyMagnet to imput data</strong></p>
<p>We also normalize the data as if it is a wavefunction, this is to avoid the normalization issue we just discussed. Though a real implementation would need to have a way to extract the norm using some gauging function <span class="math notranslate nohighlight">\(G(I)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; CosyMagnet to flatten the data &#39;&#39;&#39;</span>
<span class="n">emulator</span> <span class="o">=</span> <span class="n">CosyMagnet</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;MagnetData/Q1/train&quot;</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39; We normalize &#39;&#39;&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="n">matrix</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span> <span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">v</span> <span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create a Hamiltonian finder object, here dimension refers to the number of principal components to be included on the Hamiltonian model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hamiltonian</span> <span class="o">=</span> <span class="n">RealHamiltonian</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="n">xs</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">emulator</span><span class="o">.</span><span class="n">axis</span><span class="p">],</span><span class="n">data</span><span class="o">=</span><span class="n">emulator</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">dimension</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">order</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="n">hamiltonian</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span><span class="n">order</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Always positive component so we can gauge &#39;&#39;&#39;</span>
<span class="n">judgeIndex</span> <span class="o">=</span> <span class="mi">1367</span>
<span class="n">sign</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span> <span class="p">:</span> <span class="n">p</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">judgeIndex</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">hamiltonian</span><span class="o">.</span><span class="n">predict_real</span><span class="p">(</span><span class="n">emulator</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">prediction</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">emulator</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Real Hamiltonian&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sqrt{\sum ||Emulated - Data||^2 }$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/17d162b54963a070c3a3bde679eab107c16091f6b629a5447014f0ff90240e90.png" src="../_images/17d162b54963a070c3a3bde679eab107c16091f6b629a5447014f0ff90240e90.png" />
</div>
</div>
<p>And it works! We have obtained a reduced effective equation for our tensor <span class="math notranslate nohighlight">\(S^l\)</span> expanded in our reduced basis.</p>
<p>In the next subsection, we apply the same ideas to a system in which we know the exact governing equations, but on which performing the traditional Galerkin projections becomes problematic.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./blackbox_galerkin"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Introduction.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Aplication 5: Black-Box Methods</p>
      </div>
    </a>
    <a class="right-next"
       href="DFT_Toy_Model.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Non-linear and non-affine problem</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolation-emulator-for-secar">Interpolation Emulator for SECAR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-helpers-for-reading-cosy-files">Some helpers for reading COSY files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cubicspline-based-emulator">CubicSpline based Emulator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interface-between-cosy-file-reading-and-the-emulators">Interface between COSY file reading and the emulators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#black-box-emulator-for-secar">Black-Box Emulator for SECAR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#we-now-try-a-new-approach-which-more-closely-resembles-the-galerkin-approach-to-rbm-s">We now try a new approach which more closely resembles the Galerkin approach to RBM’s.</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Advanced Scientific Computing and Statistics Network
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>